import{FFmpeg as e}from"/javascript/ffmpeg/ffmpeg/index.js";import{fetchFile as t}from"https://cdn.jsdelivr.net/npm/@ffmpeg/util@0.12.1/dist/esm/index.min.js";let o,i,n=null,a=!1;const l=document.getElementById("videoInput"),u=document.getElementById("outputName"),s=document.getElementById("convertButton"),m=document.getElementById("downloadLink"),p=document.getElementById("mode").textContent;async function c(){console.log("multithreading engaged"),await n.load({coreURL:"https://cdn.jsdelivr.net/npm/@ffmpeg/core-mt@0.12.4/dist/esm/ffmpeg-core.js",wasmURL:"https://cdn.jsdelivr.net/npm/@ffmpeg/core-mt@0.12.4/dist/esm/ffmpeg-core.wasm",workerURL:"/javascript/ffmpeg/multi-thread/ffmpeg-core.worker.js"})}async function d(){console.log("singlethreading engaged"),await n.load({coreURL:"https://cdn.jsdelivr.net/npm/@ffmpeg/core@0.12.4/dist/esm/ffmpeg-core.js"})}const r=async()=>{null===n&&(n=new e,n.on("log",(({message:e})=>{console.log(e)})),"merge"===p?n.on("progress",(({progress:e,time:t})=>{message.innerHTML=t/1e6+" s"})):n.on("progress",(({progress:e})=>{message.innerHTML=100*e+" %"})),a?await c():await d())};function g(e){const t=[];let o="",i=!1;for(let n=0;n<e.length;n++){const a=e.charAt(n);'"'===a?i=!i:" "!==a||i?o+=a:o&&(t.push(o),o="")}return o&&t.push(o),t}const F=(e,t)=>({conversion:`-i "${e.inputFileName}" "${e.outputFileName}"`,trim:`-ss "${e.start.time}" -i "${e.inputFileName}" -ss "${e.start.time}" -i "${e.inputFileName}" -t ${e.end.time} -map 0:v -map 1:a -c:v copy -c:a copy "${e.outputFileName}"`,merge:`-f concat -safe 0 -i concat_list.txt -c:v copy -c:a copy "${e.outputFileName}"`,split:`-i "${e.inputFileName}" -t ${e.start.time} -c:v copy -c:a copy "${e.outputFileName}" -ss ${e.start.time} -c:v copy -c:a copy "${e.outputFileName2}"`,resize:`-i "${e.inputFileName}" -vf "scale=${e.size},setsar=1:1" ${e.outputFileName}`,removeaudio:`-i "${e.inputFileName}" -c:v copy -an "${e.outputFileName}"`,crop:`-i "${e.inputFileName}" -vf crop=${e.dimension} ${e.outputFileName}`,getaudio:`-i "${e.inputFileName}" "${e.outputFileName}"`,textoverlay:`-i "${e.inputFileName}" -vf drawtext="${e.drawtext}" ${e.outputFileName}`}[t]),y=async(e,o)=>{switch(o){case"conversion":case"trim":case"split":case"removeaudio":case"resize":case"crop":case"getaudio":case"textoverlay":console.log(e.inputFileName),console.log(e.videoFile.name),await n.writeFile(e.inputFileName,await t(e.videoFile));break;case"merge":console.log("Start Concating");const o=[];for(const i of e.videoFile){const{name:e}=i;n.writeFile(e,await t(i)),o.push(`file '${e}'`)}console.log(o),await n.writeFile("concat_list.txt",o.join("\n"));break;default:console.log("path not found")}message.innerHTML="Start transcoding";const i=g(await F(e,o));console.log(i),console.log(i),await n.exec(i),message.innerHTML="transcoding completed"},v=async e=>{const t=await n.readFile(e.outputFileName),a=document.getElementById("output-video"),l=`video/${e.outputFileType}`,u=URL.createObjectURL(new Blob([t.buffer],{type:l}));if(a.src=u,o&&URL.revokeObjectURL(o),o=u,m.href=u,m.download=e.outputFileName,m.style.display="block","split"===p){console.log("i am inside split");const t=await n.readFile(e.outputFileName2),o=URL.createObjectURL(new Blob([t.buffer],{type:l}));i&&URL.revokeObjectURL(i),i=o;var s=document.getElementById("downloadLink2");s.href=o,s.download=e.outputFileName2,s.style.display="block"}a.classList.contains("hidden")&&a.classList.toggle("hidden")};function $(e,t){const o=e.split(":").map(Number),i=t.split(":").map(Number),n=3600*o[0]+60*o[1]+o[2],a=3600*i[0]+60*i[1]+i[2]-n,l=Math.floor(a/3600),u=Math.floor(a%3600/60),s=a%60;return`${l.toString().padStart(2,"0")}:${u.toString().padStart(2,"0")}:${s.toString().padStart(2,"0")}`}async function f(){a=!a,console.log(`is multithreaded = ${a}`),a?await c():await d()}const N=document.getElementById("toggleModeButton");async function h(){console.log("loading ffmpeg"),await r()}N.addEventListener("click",f),h(),s.addEventListener("click",(async()=>{if(!l.files.length||!u.value)return void alert("Please select a video and provide an output name.");document.getElementById("message");var e={videoFile:l.files[0],inputFileName:"",outputFileN:document.getElementById("outputName").value,outputFileType:"",outputFileName:"",outputFileName2:"",start:{hour:0,minute:0,second:0},end:{hour:0,minute:0,second:0},duration:"",size:"",dimension:"",audioinput:"",drawtext:""};switch(console.log("before switch for input mode"),p){case"conversion":case"getaudio":e.outputFileType=document.getElementById("outputFormat").value,e.inputFileName=e.videoFile.name,e.outputFileName=`${e.outputFileN}.${e.outputFileType}`;break;case"trim":e.inputFileName=e.videoFile.name,e.outputFileType=e.inputFileName.split(".").pop(),e.outputFileName=`${e.outputFileN}.${e.outputFileType}`,e.start={hour:document.getElementById("start_hour").value,minute:document.getElementById("start_minute").value,second:document.getElementById("start_second").value},e.end={hour:document.getElementById("end_hour").value,minute:document.getElementById("end_minute").value,second:document.getElementById("end_second").value},e.start.time=`${e.start.hour}:${e.start.minute}:${e.start.second}`,e.end.time=`${e.start.hour}:${e.end.minute}:${e.end.second}`,console.log(`Duration: ${e.end.time}`),console.log(`Duration: ${e.start.time}`),e.end.time=$(e.start.time,e.end.time),console.log(`Duration: ${e.end.time}`);break;case"merge":console.log("merging - input"),e.videoFile=l.files,console.log(e.videoFile),e.inputFileName=e.videoFile[0].name,e.outputFileType=e.inputFileName.split(".").pop(),e.outputFileName=`${e.outputFileN}.${e.outputFileType}`;const o=e.inputFileName.split(".").pop();for(var t of e.videoFile)if(t.name.split(".").pop()!=o)return void alert("input files must be of the same type");break;case"split":e.inputFileName=e.videoFile.name,e.outputFileType=e.inputFileName.split(".").pop(),e.outputFileName=`${e.outputFileN}p1.${e.outputFileType}`,e.outputFileName2=`${e.outputFileN}p2.${e.outputFileType}`,e.start={hour:document.getElementById("start_hour").value,minute:document.getElementById("start_minute").value,second:document.getElementById("start_second").value},e.start.time=`${e.start.hour}:${e.start.minute}:${e.start.second}`;break;case"resize":e.inputFileName=e.videoFile.name,e.outputFileType=e.inputFileName.split(".").pop(),e.outputFileName=`${e.outputFileN}.${e.outputFileType}`,e.size=document.getElementById("dimension").value;break;case"removeaudio":e.inputFileName=e.videoFile.name,e.outputFileType=e.inputFileName.split(".").pop(),e.outputFileName=`${e.outputFileN}.${e.outputFileType}`;break;case"crop":e.inputFileName=e.videoFile.name,e.outputFileType=e.inputFileName.split(".").pop(),e.outputFileName=`${e.outputFileN}.${e.outputFileType}`,e.dimension=`${document.getElementById("width").value}:${document.getElementById("height").value}:${document.getElementById("x").value}:${document.getElementById("y").value}`,console.log(e.dimension);break;case"textoverlay":e.inputFileName=e.videoFile.name,e.outputFileType=e.inputFileName.split(".").pop(),e.outputFileName=`${e.outputFileN}.${e.outputFileType}`,e.drawtext=`text='${document.getElementById("text").value}':x=${document.getElementById("x").value}:y=${document.getElementById("y").value}:fontsize=${document.getElementById("fontsize").value}`,console.log(` The created drawtext ${e.drawtext}`);break;default:console.log("path not found")}console.log("2"),await y(e,p),console.log("3"),v(e),console.log("4")}));const w=document.getElementById("input-video");l.addEventListener("change",(function(e){const t=e.target.files[0];if(t){console.log("File selected:",t.name);var o=URL.createObjectURL(t);w.src=o,w.classList.contains("hidden")&&w.classList.toggle("hidden")}else console.log("No file selected.")}));